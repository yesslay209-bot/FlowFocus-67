<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FocusFlow by Grace Chen</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <!-- ðŸŒ¸ Navbar -->
  <nav class="navbar">
    <div class="nav-left">
      <img src="{{ url_for('static', filename='bunny.png') }}" alt="Logo" class="nav-logo">
      <span class="nav-title">FocusFlow</span>
    </div>
    <div class="nav-right">
      <a href="{{ url_for('home') }}" class="nav-link">Home</a>
      <a href="{{ url_for('pomo') }}" class="nav-link active">Pomo</a>
      <a href="{{ url_for('bunnies_page') }}" class="nav-link">Bunny Streak</a>
      <a href="{{ url_for('music') }}" class="nav-link">Music</a>
      <a href="#" class="nav-link">Settings</a>
    </div>
  </nav>

  <!-- ðŸŒ¼ Main Content -->
  <div class="container">
    <div class="focus-card">

      <h1 class="title">FocusFlow</h1>
      <p class="subtitle">by Grace Chen</p>

      <!-- Stats -->
      <div class="stats">
        <div class="stat-item">
          <span class="stat-number" id="sessions">{{ sessions }}</span>
          <span class="stat-label">Sessions</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="streak">{{ streak }}</span>
          <span class="stat-label">Day Streak</span>
        </div>
      </div>

      <!-- Bunny -->
      <div class="bunny-container"  >
        <img src="{{ url_for('static', filename='bunny.png') }}" alt="Bunny" class="bunny" id="bunny">
      </div>

      <!-- Timer Circle -->
      <div class="timer-circle">
        <svg>
          <circle cx="100" cy="100" r="90"></circle>
          <circle id="progress" cx="100" cy="100" r="90"></circle>
        </svg>
        <div class="time" id="time">25:00</div>
      </div>

      <!-- Timer Controls -->
      <div class="controls">
        <button id="startBtn">Start</button>
        <button id="pauseBtn">Pause</button>
        <button id="resetBtn">Reset</button>
      </div>

      <!-- Quote -->
      <p class="quote" id="quote">{{ quote_focus }}</p>

      <!-- Chat Box -->
      <div style="background:#fff;padding:12px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);display:flex;flex-direction:column;height:280px;margin-top:20px;width:100%;max-width:400px;margin-left:auto;margin-right:auto;">
        <h3 style="margin:0 0 8px 0;font-size:14px;">Focus Buddy ðŸ’¬</h3>
        <div id="chatbox" style="flex:1;overflow-y:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#f9f9f9;">
          <div style="font-size:12px;color:#999;text-align:center;padding:8px;">Ask for help or motivation!</div>
        </div>
        <div style="display:flex;gap:4px;">
          <input type="text" id="chatInput" placeholder="Type a message..." style="flex:1;padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;" />
          <button onclick="sendChat()" style="padding:6px 10px;background:#6ECF9A;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;">Send</button>
        </div>
      </div>

    </div> <!-- âœ… END focus-card -->
  </div> <!-- âœ… END container -->


  <!-- ðŸŒ¸ Timer Script -->
  <script>
    const FULL_DASH_ARRAY = 565.48;
    const progress = document.getElementById("progress");
    const timeDisplay = document.getElementById("time");
    const quote = document.getElementById("quote");
    const bunny = document.getElementById("bunny");

    let focusTime = 25 * 60;
    let breakTime = 5 * 60;
    let timeLeft = focusTime;
    let isBreak = false;
    let running = false;
    let timer = null;

    function updateTimer() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timeDisplay.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
      const total = isBreak ? breakTime : focusTime;
      const progressFraction = (total - timeLeft) / total;
      const offset = FULL_DASH_ARRAY * (1 - progressFraction);
      progress.style.strokeDashoffset = offset;

      if (timeLeft <= 0) {
        clearInterval(timer);
        running = false;
        if (!isBreak) {
          // Mark a completed session
          fetch("/complete", {method: "POST"})
            .then(response => response.json())
            .then(data => {
              document.getElementById("sessions").textContent = data.completed_sessions;
              document.getElementById("streak").textContent = data.streak;
            });

          // Switch to break mode
          isBreak = true;
          timeLeft = breakTime;
          document.body.classList.add("break-mode");
          progress.style.stroke = "#C4EAD3";
          quote.textContent = "{{ quote_break }}";
          bunny.classList.add("hop");
          setTimeout(startTimer, 2000);
        } else {
          // Return to focus mode
          isBreak = false;
          timeLeft = focusTime;
          document.body.classList.remove("break-mode");
          progress.style.stroke = "#f08c9b";
          quote.textContent = "{{ quote_focus }}";
          bunny.classList.remove("hop");
        }
      }
    }

    function startTimer() {
      if (!running) {
        running = true;
        timer = setInterval(() => {
          timeLeft--;
          updateTimer();
        }, 1000);
      }
    }

    document.getElementById("startBtn").onclick = startTimer;
    document.getElementById("pauseBtn").onclick = () => {
      if (running) {
        clearInterval(timer);
        running = false;
      } else startTimer();
    };
    document.getElementById("resetBtn").onclick = () => {
      clearInterval(timer);
      running = false;
      isBreak = false;
      timeLeft = focusTime;
      updateTimer();
      document.body.classList.remove("break-mode");
      progress.style.stroke = "#f08c9b";
      quote.textContent = "{{ quote_focus }}";
      bunny.classList.remove("hop");
    };

    progress.style.strokeDasharray = FULL_DASH_ARRAY;
    progress.style.strokeDashoffset = FULL_DASH_ARRAY;
    updateTimer();

    // Chat function
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (!msg) return;
      
      const chatbox = document.getElementById('chatbox');
      
      // Add user message to chat
      const userDiv = document.createElement('div');
      userDiv.style.cssText = 'margin:6px 0;padding:6px 8px;background:#D6F0FF;border-radius:6px;font-size:12px;text-align:right;';
      userDiv.textContent = msg;
      chatbox.appendChild(userDiv);
      input.value = '';
      chatbox.scrollTop = chatbox.scrollHeight;
      
      // Call backend
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({message: msg})
        });
        const data = await res.json();
        
        if (res.ok) {
          const botDiv = document.createElement('div');
          botDiv.style.cssText = 'margin:6px 0;padding:6px 8px;background:#F0FFF4;border-radius:6px;font-size:12px;';
          botDiv.textContent = data.reply;
          chatbox.appendChild(botDiv);
        } else {
          const errDiv = document.createElement('div');
          errDiv.style.cssText = 'margin:6px 0;padding:6px 8px;background:#FFD6D6;border-radius:6px;font-size:12px;color:#c00;';
          errDiv.textContent = 'Error: ' + (data.error || 'Could not get response');
          chatbox.appendChild(errDiv);
        }
      } catch (e) {
        const errDiv = document.createElement('div');
        errDiv.style.cssText = 'margin:6px 0;padding:6px 8px;background:#FFD6D6;border-radius:6px;font-size:12px;color:#c00;';
        errDiv.textContent = 'Error: ' + e.message;
        chatbox.appendChild(errDiv);
      }
      chatbox.scrollTop = chatbox.scrollHeight;
    }
    
    // Allow Enter key to send
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat();
    });
  </script>
</body>
</html>
