<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bunny Streak - FocusFlow</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .cards {display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-top:16px}
    .card {width:150px;height:200px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px;box-shadow:0 4px 8px rgba(0,0,0,0.08);}
    .emoji {font-size:36px}
    .card-name{font-weight:600;margin-top:8px;text-align:center}
    .claim-btn{margin-top:10px;padding:6px 10px;border-radius:8px;border:none;background:#6ECF9A;color:#fff;cursor:pointer}
    .disabled{opacity:0.5;cursor:not-allowed}
    .section{max-width:900px;margin:0 auto;padding:12px}
    .bunny-slot {
      position:relative;
      width:140px;
      height:190px;
      margin:8px;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 4px 8px rgba(0,0,0,0.08);
      cursor:pointer;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .bunny-slot:hover {
      transform:translateY(-2px);
      box-shadow:0 6px 12px rgba(0,0,0,0.12);
    }
    .bunny-slot.collected {
      opacity:0.6;
    }
    .bunny-slot.collected:hover {
      opacity:1;
    }
    .bunny-slot.selected {
      border:3px solid #6ECF9A;
    }
    .bunny-slot-content {
      width:100%;
      height:120px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:4px;
    }
    .bunny-slot-img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <img src="{{ url_for('static', filename='bunny.png') }}" alt="Logo" class="nav-logo">
      <span class="nav-title">FocusFlow</span>
    </div>
    <div class="nav-right">
      <a href="{{ url_for('home') }}" class="nav-link">Home</a>
      <a href="{{ url_for('pomo') }}" class="nav-link">Pomo</a>
      <a href="{{ url_for('bunnies_page') }}" class="nav-link active">Bunny Streak</a>
      <a href="{{ url_for('music') }}" class="nav-link">Music</a>
      <a href="#" class="nav-link">Settings</a>
    </div>
  </nav>

  <div class="section" style="display:flex;gap:20px;align-items:flex-start;">
    <div style="flex:1">
      <h1>Bunny Streak</h1>
      <p>Collect cute bunnies like cards. Each day you extend your streak you get to choose one of the daily cards.</p>

      <div class="cards" id="slots" style="justify-content:flex-start;flex-wrap:wrap;">
        {% set collected = user_data.collection %}
        {% set selected = user_data.selected_bunny %}
        {% for b in bunnies[:7] %}
          {% set is_collected = b.id in collected %}
          {% set unlocked = user_data.streak >= b.unlock_streak %}
          {% set is_selected = b.id == selected %}
          <div class="bunny-slot {% if is_collected %}collected{% endif %} {% if is_selected %}selected{% endif %}" style="background: {{ b.color }};" data-bunny-id="{{ b.id }}" onclick="selectBunny('{{ b.id }}')">
            <div class="bunny-slot-content">
              {% if is_collected or unlocked %}
                <img src="{{ url_for('static', filename=b.image) }}" alt="{{ b.name }}" class="bunny-slot-img" />
              {% else %}
                <div style="display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.5);font-size:40px;width:100%;height:100%;">ðŸ”’</div>
              {% endif %}
            </div>
            <div class="card-name">{{ b.name }}</div>
            <div class="card-desc">{{ b.desc }}</div>
            {% if is_collected %}
              <div style="position:absolute;top:8px;right:8px;background:#fff;border-radius:8px;padding:4px 6px;font-size:12px">âœ“</div>
            {% elif not unlocked %}
              <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.6);color:#fff;padding:6px;border-radius:6px;font-size:12px">Locked â€” {{ b.unlock_streak }}d</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <h2 style="margin-top:24px">Today's Options</h2>
      <div id="options-area">
        {% if user_data.available_date %}
          <p>Available date: {{ user_data.available_date }}</p>
        {% endif %}

        <div class="cards" id="options">
          {% if user_data.available_options %}
            {% for opt_id in user_data.available_options %}
              {% for b in bunnies %}
                {% if b.id == opt_id %}
                  <div class="card" style="background: {{ b.color }};position:relative;width:150px;height:200px;overflow:hidden;" data-id="{{ b.id }}">
                    <img src="{{ url_for('static', filename=b.image) }}" alt="{{ b.name }}" style="width:100%;height:120px;object-fit:cover;margin-bottom:4px;" />
                    <div class="card-name">{{ b.name }}</div>
                    <div class="card-desc">{{ b.desc }}</div>
                    {% if not user_data.available_claimed and user_data.streak >= b.unlock_streak %}
                      <button class="claim-btn" onclick="claimCard('{{ b.id }}')">Claim</button>
                    {% elif not user_data.available_claimed and user_data.streak < b.unlock_streak %}
                      <button class="claim-btn disabled" disabled>Locked</button>
                    {% else %}
                      <button class="claim-btn disabled" disabled>Claimed</button>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            {% endfor %}
          {% else %}
            <p>No card options available right now â€” keep building your streak!</p>
          {% endif %}
        </div>
      </div>
    </div>

    <aside style="width:300px;flex-shrink:0;display:flex;flex-direction:column;gap:16px;">
      <!-- Streak Box -->
      <div style="background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);">
        <h3>Your Streak</h3>
        <div style="font-size:40px;font-weight:700">{{ user_data.streak }}</div>
        <p>Days in a row</p>
        <hr />
        <h4>Next Unlocks</h4>
        <ul style="padding-left:18px;max-height:200px;overflow-y:auto;">
          {% for b in bunnies %}
            {% if b.id not in collected %}
              <li style="margin-bottom:6px;font-size:13px">{{ b.name }} â€” {{ b.unlock_streak }} days {% if user_data.streak >= b.unlock_streak %}(available){% endif %}</li>
            {% endif %}
          {% endfor %}
        </ul>
      </div>

      <!-- Chat Box -->
      <div style="background:#fff;padding:12px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);display:flex;flex-direction:column;height:350px;">
        <h3 style="margin:0 0 8px 0;">Focus Buddy ðŸ’¬</h3>
        <div id="chatbox" style="flex:1;overflow-y:auto;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#f9f9f9;">
          <div style="font-size:12px;color:#999;text-align:center;padding:8px;">Ask for help or motivation!</div>
        </div>
        <div style="display:flex;gap:4px;">
          <input type="text" id="chatInput" placeholder="Type a message..." style="flex:1;padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;" />
          <button onclick="sendChat()" style="padding:6px 10px;background:#6ECF9A;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;">Send</button>
        </div>
      </div>
    </aside>
  </div>

<script>
  async function claimCard(cardId){
    const res = await fetch('/claim_card', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({card_id: cardId})
    });
    const data = await res.json();
    if(res.ok){
      // simple refresh to show collection update
      location.reload();
    } else {
      alert(data.error || 'Could not claim card');
    }
  }

  async function selectBunny(bunnyId){
    const res = await fetch('/select_bunny', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({bunny_id: bunnyId})
    });
    const data = await res.json();
    if(res.ok){
      // Update UI to show selected state
      document.querySelectorAll('.bunny-slot').forEach(slot => {
        slot.classList.remove('selected');
      });
      document.querySelector(`[data-bunny-id="${bunnyId}"]`).classList.add('selected');
    } else {
      alert(data.error || 'Could not select bunny');
    }
  }

  async function sendChat() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    
    const chatbox = document.getElementById('chatbox');
    
    // Add user message to chat
    const userDiv = document.createElement('div');
    userDiv.style.cssText = 'margin:6px 0;padding:6px 8px;background:#D6F0FF;border-radius:6px;font-size:12px;text-align:right;';
    userDiv.textContent = msg;
    chatbox.appendChild(userDiv);
    input.value = '';
    chatbox.scrollTop = chatbox.scrollHeight;
    
    // Call backend
    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message: msg})
      });
      const data = await res.json();
      
      if (res.ok) {
        const botDiv = document.createElement('div');
        botDiv.style.cssText = 'margin:6px 0;padding:6px 8px;background:#F0FFF4;border-radius:6px;font-size:12px;';
        botDiv.textContent = data.reply;
        chatbox.appendChild(botDiv);
      } else {
        const errDiv = document.createElement('div');
        errDiv.style.cssText = 'margin:6px 0;padding:6px 8px;background:#FFD6D6;border-radius:6px;font-size:12px;color:#c00;';
        errDiv.textContent = 'Error: ' + (data.error || 'Could not get response');
        chatbox.appendChild(errDiv);
      }
    } catch (e) {
      const errDiv = document.createElement('div');
      errDiv.style.cssText = 'margin:6px 0;padding:6px 8px;background:#FFD6D6;border-radius:6px;font-size:12px;color:#c00;';
      errDiv.textContent = 'Error: ' + e.message;
      chatbox.appendChild(errDiv);
    }
    chatbox.scrollTop = chatbox.scrollHeight;
  }
  
  // Allow Enter key to send
  document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendChat();
  });
</script>
</body>
</html>
